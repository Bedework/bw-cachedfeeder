<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <title>
      RPI Event Feed Builder
    </title>

    <script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.7.2.min.js"></script>
    <link type="text/css" href="css/ui-lightness/jquery-ui-1.7.2.custom.css" rel="stylesheet" />
    

    <style type="text/css">
      ul.NoBullet {
        list-style-type: none
      }
      BODY { 
        background-color: #D0D0D0
      }
      input.slider {
        border:0;
        background:#D0D0D0;
        color:#f6931f;
        font-weight:bold;
      }
      input.datepicker {
        background:#D0D0D0;
      }
      input.allClicker {
        background: #f6931f;
        width: 30px;
        height: 30px;   
      }
    </style> 

    <script type="text/javascript">

      // use JQuery UI slider widget for number of days
      $(function() {
        $("#slider").slider({
          range: "min",
          min: 0,
          max: 100,
          value: 7,
          slide: function(event, ui) {
            $("#numDays").val(ui.value);
            updateURL();
          }
        });
        $("#numDays").val($("#slider").slider("value"));
        });
                
      function sortByFirstColumn(a,b) {
          var x = a[0].toLowerCase();
          var y = b[0].toLowerCase();
          return ((x < y) ? -1 : ((x > y) ? 1 : 0));
      }
                
      var cats;  // holds category tree returned by json call.
      var grps;  // holds category tree returned by json call.

      function getCatandGroupData() {
        $.getJSON("http://localhost:8080/cal/widget/categories.do?skinName=widget-json-cats", function(catData) {
          $.getJSON("http://localhost:8080/cal/widget/groups.do?skinName=widget-json-groups", function(groupData) {     
            grps = groupData; 
            processGroupData();
          });  
          cats = catData; 
          processCatData();
        });
      }
    
      function sortByCreator(a,b) {
        a = a.creator;
        b = b.creator;
        return a == b ? 0 : (a < b ? -1 : 1)
      }
       
      function processCatData() {
    
        //set n to the number of columns 
        var n = 4;
        
        //initialize with all/none button and start of first row.
        // allNoneClickerLine = "<input type=\"checkbox\" onclick=\"checkAll(this.id, 'activities')\" class=\"allClicker\" name=\"allClicker\" id=\"allClicker\"/><label for=\"allClicker\">Select all/none</label>";

        // var trLine = "<tr><td>" + allNoneClickerLine + "</td></tr>";     
        //$("#activities").append(trLine);
        var currentCreator = "";    
        $.each(cats.bwCategories.categories.sort(sortByCreator), function(i, category){
          catCreator = category.creator.replace("/principals/users/","");
          catKeyword = category.keyword;
          catID = category.id;  
          catCreatorLine = "<td>Created by: <b>" + catCreator + "</b></td>"
          tdLine = "<td><input type=\"checkbox\" name=\"categoryChecks\" onclick=\"updateURL()\" value=\"" + catID +  "\">" + catKeyword + "</td>";
          if (currentCreator == "") {   
            trLine = "<tr>" + catCreatorLine + "</tr>";
            $("#activities").append(trLine);
            trLine = "<tr>" + tdLine;
            column = 2;
            currentCreator = catCreator;
          } else if (currentCreator != catCreator) {
            $("#activities").append(trLine + "</tr><tr>" + catCreatorLine + "</tr>");
            trLine = "<tr>" + tdLine;   
            column = 2;
            currentCreator = catCreator;
          } else {
            //arrange the categories -- n checkboxes per line      
            if ( column != n ) {
              trLine = trLine + tdLine;
              column++; 
            } else {
              trLine = trLine + tdLine + "</tr>";
              $("#activities").append(trLine);
              trLine = "<tr>"
              column = 1;
            }
          }   
        });
         
        if ( column == 1) {
          lastLine = "</tr>";
        } else {
          lastLine = trLine + "</tr>";
        }
        $("#activities").append(lastLine);      
      }

      function replaceAll(text, strA, strB) {
        while ( text.indexOf(strA) != -1)
        {
            text = text.replace(strA,strB);
        }
        return text;
      }
    
      
      function processGroupData() {
        trLine = "<tr><td><input type=\"radio\" id=\"noLimit\" name=\"groupCheck\" onclick=\"updateURL()\" value=\"noLimit\">No Limit</td></tr>";
        $("#filter").append(trLine);
        $.each(grps.bwGroups.groups, function(i, group){ 
           eventOwner = replaceAll(group.eventOwner,"/","~");
           trLine = "<tr><td><input type=\"radio\" id=\"" + group.name + "\" name=\"groupCheck\" onclick=\"updateURL()\" value=\"" + eventOwner +  "\">" + group.name + "</td></tr>";
           $("#filter").append(trLine);
        }); 
      }
    
      function updateURL(){
        prefix = "http://localhost:3000/"
        
        // Four cases:  
        //   (1)  ics with number of days specified.  Other parameters: group, categories
        //   (2)  ics with date range specified.  Other parameters: group, categories
        //   (3)  other feed with number of days specified.  Other parameters: skin, group, categories
        //   (4)  other feed with date range specified.  Other paramters: skin, group, categories
    
        ics = false;
        byDays = false;

        if  (document.getElementById('startEndDates').checked == true) { 
          startDate = document.getElementById('startDate').value;
          if (startDate == "") {
            startDate = '0000-00-00';
          }
          endDate = document.getElementById('endDate').value;
          if (endDate == "") {
            endDate = '0000-00-00';
          }
          dates = startDate + '/' + endDate;
        } else {
            byDays = true;
            numberOfDays = document.getElementById('numDays').value;
        }
        
        if (document.getElementById('ics').checked == true) {
            ics = true; 
        } else {
            skin = $("input[name='dataType']:checked").val();
        }
        if (ics) {
          if (byDays) {
             constructedURL = prefix + "icsDays"  + "/" + numberOfDays + "/"
          } else {
             constructedURL = prefix + "icsRange"  + "/" + dates + "/"
          }
        } else {
          if (byDays) {
            constructedURL = prefix + "genFeedDays"  + "/" + numberOfDays + "/" + skin + "/"
          } else {
            constructedURL = prefix + "genFeedRange"  + "/" + dates + "/" + skin + "/"
          }
        }
        constructedURL = constructedURL + getGroupValue();

        if (document.getElementById('allCategories').checked == true) {
          constructedURL = constructedURL + '/all';
        } else {
          catList = constructCategoryList();
          if (catList.length == 0 ) {
            constructedURL = constructedURL + '/all';
          } else {
            constructedURL = constructedURL + '/' + catList;
          }
        }
        //document.getElementById('URLBox1').innerHTML = constructedURL;
        // document.getElementById('URLBox1').href = constructedURL;
        document.getElementById('URLBox2').innerHTML = constructedURL;
        document.getElementById('URLBox2').href = constructedURL;
      }

      // check all/check none button.  Thanks to Adrian J. Moreno.
      function checkAll(id, pID) {
        $( "#" + pID + " :checkbox").attr('checked', $('#' + id).is(':checked'));
        updateURL()
      }

      function getGroupValue () {
        return $("input[name='groupCheck']:checked").val();
      }

      // construct category parameters
      function constructCategoryList () {
        var categoryIDList = "";
        $("input[name='categoryChecks']:checked").each(function() {
          if (categoryIDList == "") {
              categoryIDList = this.value;
          } else {
              categoryIDList = categoryIDList + "~" + this.value;
          }
        });
        return categoryIDList;
      }

      $(document).ready(function(){ 
        $(".dataFormat").hide('slow');
        $(".timeframeUnit").hide('slow');
        $(".output").hide('slow');
        $(".type").hide('slow');
        $(".URL").hide('slow');
        $(".codeBoxes").hide('slow');
        //$('#startDate').attr('disabled', 'disabled'); 
        //$('#endDate').attr('disabled', 'disabled'); 
        //$('#numDays').attr('disabled', 'disabled'); 
        $(".trigger").click(function(){
          if($('#feed').attr('checked')) {
            // feed
            $(".dataFormat").show('slow');
            $(".timeframeUnit").show('slow');
            $(".output").hide('slow');
            $(".type").hide('slow');
            $(".URL").show('slow');
            $(".codeBoxes").hide('slow');
          } else {
            // widget
            $(".dataFormat").hide('slow');
            $(".timeframeUnit").hide('slow');
            $(".output").show('slow');
            $(".type").show('slow');
            $(".URL").hide('slow');
            $(".codeBoxes").show('slow');
          }
          if($('#checkedCategories').attr('checked')) {
            $(".selectCategories").show('slow');
          } else {
            $(".selectCategories").hide('slow');
          }
        });
        
        getCatandGroupData();
    
        updateURL();
    
        $(function() {
          $("#startDate").datepicker({ 
            dateFormat: 'yy-mm-dd',
            onSelect: function(dateText, inst) {
              updateURL();
            }
          });
        });
        $(function() {
          $("#endDate").datepicker({ 
            dateFormat: 'yy-mm-dd',
            minDate: $('#startDate').datepicker('getDate'),
            onSelect: function(dateText, inst) {
              updateURL();
            }
          });
        });
  
        
      });
    </script>
  </head>

  <body>  
    <form>
    
      <h1>RPI Events URL Builder</h1>

      <p>Raw feed or an embeddable widget?</p>
      <ul class="NoBullet">    
        <li class="trigger">
          <input type="radio" onclick='updateURL()' id="feed" name="feedOrWidget" value="feed" />Feed
        </li>      
        <li class="trigger">
          <input type="radio" id="widget" name="feedOrWidget" value="widget" />Widget
        </li>
      </ul>

      <div class="dataFormat">
        <p>Data format?</p>
        <ul class="NoBullet">
          <li>
            <input type="radio" id="rss" onclick='updateURL()' name="dataType" value="rss"/>RSS
          </li>
          <li>
            <input type="radio" id="json" onclick='updateURL()' name="dataType" value="json" />JSON
          </li>
          <li>
            <input type="radio" id="ics" onclick='updateURL()' name="dataType" value="ics" />ICS (iCalendar)
          </li>
          <li>
            <input type="radio" id="xml" onclick='updateURL()' name="dataType" value="xml" />XML
          </li>
            <input type="radio" id="html" onclick='updateURL()' name="dataType" value="html" />HTML
          </li>
        </ul>
      </div>  <!-- DataFormat -->

     
      <div class="timeframeUnit">
        <p>
          Specify the number of days (from the current date) or provide a start date and an end date.
        </p>
        <ul class="NoBullet"><li><table>
          <tr> 
            <td>
              <input type="radio" id="numberOfDays" name="timeframe" onclick="updateURL()" value="days" checked="checked" />
            </td>
            <td>
              <div class="daysNumber">      
                 <div class="days">
                    <div id="slider" style="width:300px;"></div>
                 </div>
                 <label for="numDays">Number of Days:</label><input class="slider" onclick='updateURL()' type="text" id="numDays" />  
              </div>
            </td>
          </tr>
          <tr> 
            <td>
              <input type="radio" id="startEndDates" name="timeframe" onclick="updateURL()" value="dates" checked="checked" />
            </td>
            <td>
               <div class="dateRange">
                 Start Date: <input size="10" class="datepicker" id="startDate" onclick="updateURL()" type="text">
                 End Date: <input size="10"class="datepicker" id="endDate" onclick="updateURL()" type="text">
               </div>
            </td>
          </tr>
        </li></table></ul>
      </div>  <!-- timeframeUnit -->

      <div class="output">
        <p>
          Output?
        </p>
        <ul class="NoBullet">
          <li>
            <input type="radio" id="iframe" name="output" value="iframe" />iframe (html)
          </li>
          <li>
            <input type="radio" id="javascript" name="output" value="javascript"/>Javascript
          </li>
        </ul>
      </div>

    
      <div class="type">
        <p>
          Type?
        </p>
        <ul class="NoBullet">
          <li>
            <input type="radio" id="list" name="type" value="List" />List
          </li>
          <li>
            <input type="radio" id="week" name="type" value="Week" checked="checked" />Current Week
          </li>
          <li>
            <input type="radio" id="month" name="type" value="Month" />Current Month
          </li>
        </ul>
      </div>

      <div class="categories">
        <p>
          Include everything or only those events from selected categories (Lectures, Arts Events, etc.)?
        </p>
        <ul class="NoBullet">
          <li class="trigger">
            <input type="radio" id="allCategories" name="allOrSomeCats" onclick='updateURL()' value="all" checked="checked"/>Include everything
          </li>
          <li  class="trigger">
            <input type="radio" id="checkedCategories" name="allOrSomeCats" onclick='updateURL()' value="selectedCats" />Include selected categories only
          </li>  
        </ul>

        
        <div class="selectCategories"><ul class="NoBullet"><li>
          <table id="activitiesTable">
            <tbody id="activities">
            </tbody>
          </table>
        </div>  <!-- selectCategories -->
      </li></ul></div> <!-- categories -->
    
        <p>
          Limit To:
        </p>
    
      <div class="selectGroup">
         <table>
            <tbody id="filter" /> 
            </tbody>
        </table>
      </div>    
      

      <div class="URL">
        <p>
          Your URL: <a href="" id="URLBox2"></a>
        </p>
      </div>
        
      </div class=codeBoxes>
        <p>
          CSS
        </p>
        <textarea name="css" id="css" rows="20" cols="60"></textarea>
        <p>
          JavaScript Functions
        </p>
        <textarea name="functions" id="functions" rows="20" cols="60"></textarea>
      </div>
    </form>
  </body>
</html>